name: assignment-test

on:
  push:
    tags-ignore:
      - '*'
    branches:
      - '*'
  workflow_dispatch:

jobs:
  full-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          submodules: 'recursive'

      - name: Disk diagnostics (before cleanup)
        run: |
          echo "=== df -h ==="
          df -h || true
          echo "=== workspace du (top-level) ==="
          du -sh . || true
          echo "=== build folder du (if exists) ==="
          du -sh build || true
          du -sh build/* || true

      - name: Prepare /mnt storage for Yocto caches
        run: |
          sudo mkdir -p /mnt/yocto-tmp /mnt/sstate-cache /mnt/downloads
          sudo chmod 777 /mnt/yocto-tmp /mnt/sstate-cache /mnt/downloads
          echo "Created /mnt/yocto-tmp, /mnt/sstate-cache, /mnt/downloads"

      - name: Show host docker usage (no prune yet)
        run: |
          echo "Host docker usage:"
          docker system df || true
          echo "Skipping prune until after full-test to avoid re-pulling the test image."

      - name: Restore Yocto caches to /mnt
        uses: actions/cache@v4
        with:
          path: |
            /mnt/sstate-cache
            /mnt/downloads
          key: runner.os-yocto-${{ github.ref }}-${{ hashFiles('**/conf/layer.conf', '**/conf/bblayers.conf') }}
          restore-keys: |
            runner.os-yocto-${{ github.ref }}-
            runner.os-yocto-

      - name: Pre-create build local.conf to point Yocto at /mnt
        run: |
          mkdir -p build/conf
          printf '%s\n' \
            'TMPDIR ?= "/mnt/yocto-tmp"' \
            'SSTATE_DIR ?= "/mnt/sstate-cache"' \
            'DL_DIR ?= "/mnt/downloads"' \
            'INHERIT += "rm_work"' \
            '# Reduce parallelism if disk churn is still a problem:' \
            'BB_NUMBER_THREADS ?= "2"' \
            'PARALLEL_MAKE ?= "-j 2"' > build/conf/local.conf
          echo "Wrote build/conf/local.conf with /mnt paths"

      - name: Start SSH agent
        uses: webfactory/ssh-agent@v0.5.4
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Debug-inspect test image and workspace (runs in the build image)
        run: |
          IMG=cuaesd/aesd-autotest:24-assignment6-yocto
          echo "Pulling ${IMG} for inspection..."
          docker pull ${IMG} >/dev/null || true
          echo "Inspecting workspace & /mnt from inside ${IMG}:"
          docker run --rm -v ${GITHUB_WORKSPACE}:${GITHUB_WORKSPACE} -v /mnt:/mnt ${IMG} sh -c "
            echo 'Inside container: whoami:'; whoami || true
            echo 'Inside container: id of pokyuser:'; id pokyuser || true
            echo 'Workspace root:' ${GITHUB_WORKSPACE}
            echo 'Listing workspace top-level:'; ls -al ${GITHUB_WORKSPACE} || true
            echo 'Listing server dir if present:'; ls -al ${GITHUB_WORKSPACE}/server || true
            echo 'Show aesdsocket files:'; ls -al ${GITHUB_WORKSPACE}/server/aesdsocket* || true
            echo 'Check /mnt sstate/downloads perms:'; ls -ld /mnt/sstate-cache /mnt/downloads /mnt/yocto-tmp || true
            echo 'Try to write into /mnt/sstate-cache:'; touch /mnt/sstate-cache/ci_debug && echo touch_ok || echo touch_fail
          "
        shell: bash

      - name: Run build (uses /mnt)
        timeout-minutes: 600
        run: |
          docker run --rm \
            -v $SSH_AUTH_SOCK:/ssh-agent -e SSH_AUTH_SOCK=/ssh-agent \
            -e GIT_SSH_COMMAND="ssh -o StrictHostKeyChecking=no" \
            -v ${GITHUB_WORKSPACE}:${GITHUB_WORKSPACE} \
            -v /mnt:/mnt \
            cuaesd/aesd-autotest:24-assignment6-yocto \
            --workdir=${GITHUB_WORKSPACE} \
            ./build.sh

      - name: Disk diagnostics (after build)
        if: always()
        run: |
          echo "=== df -h after build ==="
          df -h || true
          echo "=== docker system df after build ==="
          docker system df || true
          echo "=== build dir du ==="
          du -sh build || true
          du -sh /mnt/sstate-cache || true
          du -sh /mnt/downloads || true

      - name: Save Yocto caches from /mnt
        if: always()
        uses: actions/cache@v4
        with:
          path: |
            /mnt/sstate-cache
            /mnt/downloads
          key: runner.os-yocto-${{ github.ref }}-${{ hashFiles('**/conf/layer.conf', '**/conf/bblayers.conf') }}

      - name: Lightweight cleanup (always)
        if: always()
        run: |
          ssh-add -D || true
          # Do not prune images here (we need the test image). Just clean build temp folders and apt caches.
          rm -rf build/tmp/* || true
          sudo rm -rf /var/lib/apt/lists/* /var/cache/apt/* || true
          echo "=== final df -h ==="
          df -h || true

      - name: Make /mnt writable for test container
        run: |
          # Ensure dirs exist
          sudo mkdir -p /mnt/yocto-tmp /mnt/sstate-cache /mnt/downloads
          IMG=cuaesd/aesd-autotest:assignment6-yocto
          echo "Pulling test image to detect pokyuser uid/gid..."
          docker pull ${IMG} >/dev/null || true
          echo "Determining pokyuser UID/GID inside ${IMG} ..."
          PUID=$(docker run --rm ${IMG} sh -c "id -u pokyuser" 2>/dev/null || true)
          PGID=$(docker run --rm ${IMG} sh -c "id -g pokyuser" 2>/dev/null || true)
          # Fallback if detection failed
          PUID=${PUID:-1000}
          PGID=${PGID:-1000}
          echo "pokyuser in image has uid=${PUID} gid=${PGID}"
          echo "Chowning /mnt dirs to ${PUID}:${PGID} and setting permissive mode..."
          sudo chown -R ${PUID}:${PGID} /mnt/yocto-tmp /mnt/sstate-cache /mnt/downloads || true
          sudo chmod -R a+rwX /mnt/yocto-tmp /mnt/sstate-cache /mnt/downloads || true
          echo "Quick write test from container (should print OK):"
          docker run --rm -v /mnt:/mnt ${IMG} sh -c "touch /mnt/sstate-cache/ci_write_test && echo OK || echo FAIL"
        shell: bash

      - name: Run full test
        timeout-minutes: 15
        run: |
          docker run --rm \
            -v ${GITHUB_WORKSPACE}:${GITHUB_WORKSPACE} \
            cuaesd/aesd-autotest:assignment6-yocto \
            --workdir=${GITHUB_WORKSPACE} \
            ./full-test.sh

      - name: Aggressive host docker cleanup (after tests)
        if: always()
        run: |
          echo "Pruning unused docker objects (images/containers/volumes)..."
          docker system df || true
          docker system prune -af --volumes || true
          echo "Post-prune df -h:"
          df -h || true
